<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出入库管理系统 - 本地存储版</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f5f7fa;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px 0 rgba(31, 38, 135, 0.2);
        }
        .chart-container {
            height: 300px;
            width: 100%;
            position: relative;
        }
        .low-stock {
            background-color: rgba(239, 68, 68, 0.2);
            color: #dc2626;
            font-weight: bold;
        }
        .highlight-text {
            position: relative;
            display: inline-block;
        }
        .highlight-text::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background-color: rgba(99, 102, 241, 0.2);
            z-index: -1;
        }
        .settings-panel {
            transition: all 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }
        .settings-panel.active {
            max-height: 500px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .storage-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4ade80;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .storage-status.show {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 存储状态提示 -->
    <div id="storageStatus" class="storage-status">数据已保存到本地存储</div>
    
    <!-- 登录模态框 -->
    <div id="loginModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50">
        <div class="glassmorphism p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center">登录系统</h2>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2" for="username">用户名</label>
                <input type="text" id="username" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 mb-2" for="password">密码</label>
                <input type="password" id="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <button id="loginBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                登录
            </button>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="mainContent" class="container mx-auto py-8 px-4 hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">出入库管理系统</h1>
            <div class="flex space-x-4">
                <button id="settingsBtn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors">
                    <i class="fas fa-cog mr-2"></i>设置
                </button>
                <button id="shareBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-share-alt mr-2"></i>分享
                </button>
                <button id="logoutBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>退出
                </button>
            </div>
        </div>

        <!-- 设置面板 -->
        <div id="settingsPanel" class="glassmorphism settings-panel">
            <h3 class="text-xl font-bold mb-4">系统设置</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold mb-3">库存告警设置</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-1">默认库存告警阈值</label>
                            <input type="number" id="defaultWarningThreshold" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" value="4">
                        </div>
                        <button id="saveSettingsBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>保存设置
                        </button>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-3">单品告警设置</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-1">选择产品</label>
                            <select id="productSelect" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- 选择产品 --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">自定义告警阈值</label>
                            <input type="number" id="customWarningThreshold" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <button id="saveProductThresholdBtn" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-check-circle mr-2"></i>应用设置
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- 数据录入区 -->
            <div class="glassmorphism p-6 card-hover lg:col-span-1">
                <h2 class="text-xl font-bold mb-4">产品信息录入</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-1">产品名称</label>
                        <input type="text" id="productName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">产品价格(元)</label>
                        <input type="number" id="productPrice" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">出入库数量</label>
                        <input type="number" id="productQuantity" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">出厂日期</label>
                        <input type="date" id="productionDate" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">保质期(天)</label>
                        <input type="number" id="shelfLife" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex space-x-4">
                        <button id="inBtn" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-arrow-down mr-2"></i>入库
                        </button>
                        <button id="outBtn" class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                            <i class="fas fa-arrow-up mr-2"></i>出库
                        </button>
                    </div>
                </div>
            </div>

            <!-- 报表生成区 -->
            <div class="glassmorphism p-6 card-hover lg:col-span-2">
                <h2 class="text-xl font-bold mb-4">报表生成</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-gray-700 mb-1">月销售额(元)</label>
                        <input type="number" id="monthlySales" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">月支出(元)</label>
                        <input type="number" id="monthlyExpenses" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-end">
                        <button id="generateReportBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-file-alt mr-2"></i>生成报表
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="reportChart"></canvas>
                </div>
                <div class="mt-4 flex space-x-4">
                    <button id="monthlyReportBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-calendar-alt mr-2"></i>月度报表
                    </button>
                    <button id="inventoryReportBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                        <i class="fas fa-boxes mr-2"></i>库存报表
                    </button>
                    <button id="exportReportBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-download mr-2"></i>导出报表
                    </button>
                </div>
            </div>
        </div>

        <!-- 库存列表 -->
        <div class="glassmorphism p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">库存列表</h2>
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="搜索产品..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">产品名称</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">价格(元)</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">库存数量</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">出厂日期</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">过期日期</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">告警阈值</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">操作</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- 库存数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <div class="text-gray-600">显示 <span id="showingCount">0</span> 条，共 <span id="totalCount">0</span> 条</div>
                <div class="flex space-x-2">
                    <button id="prevPageBtn" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50" disabled>上一页</button>
                    <span id="pageInfo">第 1 页</span>
                    <button id="nextPageBtn" class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50" disabled>下一页</button>
                </div>
            </div>
        </div>

        <!-- 交易记录 -->
        <div class="glassmorphism p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">交易记录</h2>
                <div class="flex space-x-2">
                    <select id="transactionFilter" class="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="all">所有记录</option>
                        <option value="in">入库记录</option>
                        <option value="out">出库记录</option>
                    </select>
                    <button id="clearTransactionsBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-trash-alt mr-2"></i>清空记录
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">时间</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">产品名称</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">类型</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">数量</th>
                            <th class="py-3 px-4 text-left text-gray-700 font-semibold">操作人</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                        <!-- 交易数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 数据持久化 - 本地存储实现
        const StorageService = {
            // 存储键名
            KEYS: {
                PRODUCTS: 'inventory_products',
                TRANSACTIONS: 'inventory_transactions',
                SETTINGS: 'inventory_settings',
                USER: 'inventory_user'
            },
            
            // 保存数据到本地存储
            saveData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    this.showSaveNotification();
                    return true;
                } catch (error) {
                    console.error('保存数据失败:', error);
                    return false;
                }
            },
            
            // 从本地存储加载数据
            loadData(key, defaultValue = []) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.error('加载数据失败:', error);
                    return defaultValue;
                }
            },
            
            // 显示保存成功通知
            showSaveNotification() {
                const statusEl = document.getElementById('storageStatus');
                statusEl.classList.add('show');
                
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 2000);
            }
        };

        // 应用状态管理
        const AppState = {
            products: [],
            transactions: [],
            settings: {
                defaultWarningThreshold: 4,
                productThresholds: {}
            },
            currentUser: null,
            currentPage: 1,
            itemsPerPage: 10,
            
            // 初始化应用数据
            init() {
                // 从本地存储加载数据
                this.products = StorageService.loadData(StorageService.KEYS.PRODUCTS);
                this.transactions = StorageService.loadData(StorageService.KEYS.TRANSACTIONS);
                this.settings = StorageService.loadData(StorageService.KEYS.SETTINGS, {
                    defaultWarningThreshold: 4,
                    productThresholds: {}
                });
                this.currentUser = StorageService.loadData(StorageService.KEYS.USER);
                
                // 如果已有登录用户，直接进入系统
                if (this.currentUser) {
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                }
                
                // 更新UI
                this.renderInventory();
                this.renderTransactions();
                this.updateProductSelect();
                this.initChart();
                
                // 设置默认告警阈值
                document.getElementById('defaultWarningThreshold').value = this.settings.defaultWarningThreshold || 4;
            },
            
            // 保存产品数据
            saveProducts() {
                StorageService.saveData(StorageService.KEYS.PRODUCTS, this.products);
                this.renderInventory();
                this.updateProductSelect();
            },
            
            // 保存交易记录
            saveTransactions() {
                StorageService.saveData(StorageService.KEYS.TRANSACTIONS, this.transactions);
                this.renderTransactions();
            },
            
            // 保存设置
            saveSettings() {
                StorageService.saveData(StorageService.KEYS.SETTINGS, this.settings);
            },
            
            // 添加产品入库/出库记录
            addTransaction(productName, quantity, type) {
                const transaction = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    productName,
                    quantity,
                    type,
                    operator: this.currentUser || 'admin'
                };
                
                this.transactions.unshift(transaction); // 添加到开头
                this.saveTransactions();
                
                return transaction;
            },
            
            // 更新产品库存
            updateProductStock(productName, quantity, isInStock) {
                const productIndex = this.products.findIndex(p => p.name === productName);
                
                if (productIndex >= 0) {
                    if (isInStock) {
                        this.products[productIndex].stock += quantity;
                    } else {
                        this.products[productIndex].stock = Math.max(0, this.products[productIndex].stock - quantity);
                    }
                    this.products[productIndex].updatedAt = new Date().toISOString();
                } else {
                    // 如果产品不存在则创建新产品
                    const price = parseFloat(document.getElementById('productPrice').value) || 0;
                    const productionDate = document.getElementById('productionDate').value;
                    const shelfLife = parseInt(document.getElementById('shelfLife').value) || 0;
                    
                    // 计算过期日期
                    let expirationDate = '';
                    if (productionDate && shelfLife) {
                        const date = new Date(productionDate);
                        date.setDate(date.getDate() + shelfLife);
                        expirationDate = date.toISOString().split('T')[0];
                    }
                    
                    this.products.push({
                        id: Date.now().toString(),
                        name: productName,
                        price,
                        stock: isInStock ? quantity : 0,
                        productionDate,
                        expirationDate,
                        shelfLife,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                }
                
                this.saveProducts();
            },
            
            // 获取产品告警阈值
            getProductThreshold(productName) {
                return this.settings.productThresholds[productName] || this.settings.defaultWarningThreshold;
            },
            
            // 设置产品告警阈值
            setProductThreshold(productName, threshold) {
                this.settings.productThresholds[productName] = parseInt(threshold) || this.settings.defaultWarningThreshold;
                this.saveSettings();
                this.renderInventory();
            },
            
            // 设置默认告警阈值
            setDefaultThreshold(threshold) {
                this.settings.defaultWarningThreshold = parseInt(threshold) || 4;
                this.saveSettings();
            },
            
            // 更新产品选择下拉框
            updateProductSelect() {
                const selectEl = document.getElementById('productSelect');
                selectEl.innerHTML = '<option value="">-- 选择产品 --</option>';
                
                this.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.textContent = product.name;
                    selectEl.appendChild(option);
                });
            },
            
            // 渲染库存列表
            renderInventory() {
                const tableBody = document.getElementById('inventoryTableBody');
                const searchInput = document.getElementById('searchInput').value.toLowerCase();
                const showingCountEl = document.getElementById('showingCount');
                const totalCountEl = document.getElementById('totalCount');
                
                // 过滤产品
                let filteredProducts = this.products;
                if (searchInput) {
                    filteredProducts = this.products.filter(product => 
                        product.name.toLowerCase().includes(searchInput)
                    );
                }
                
                // 分页处理
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const paginatedProducts = filteredProducts.slice(startIndex, startIndex + this.itemsPerPage);
                
                // 更新计数显示
                showingCountEl.textContent = paginatedProducts.length;
                totalCountEl.textContent = filteredProducts.length;
                
                // 更新分页按钮状态
                document.getElementById('prevPageBtn').disabled = this.currentPage === 1;
                document.getElementById('nextPageBtn').disabled = startIndex + this.itemsPerPage >= filteredProducts.length;
                document.getElementById('pageInfo').textContent = `第 ${this.currentPage} 页`;
                
                // 渲染表格内容
                tableBody.innerHTML = '';
                
                if (paginatedProducts.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" class="py-4 px-4 text-center text-gray-500">暂无产品数据</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                paginatedProducts.forEach(product => {
                    const threshold = this.getProductThreshold(product.name);
                    const isLowStock = product.stock <= threshold;
                    const stockClass = isLowStock ? 'low-stock' : '';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-3 px-4 border-b">${product.name}</td>
                        <td class="py-3 px-4 border-b">${product.price.toFixed(2)}</td>
                        <td class="py-3 px-4 border-b ${stockClass}">${product.stock} ${isLowStock ? '(库存不足)' : ''}</td>
                        <td class="py-3 px-4 border-b">${product.productionDate || '-'}</td>
                        <td class="py-3 px-4 border-b">${product.expirationDate || '-'}</td>
                        <td class="py-3 px-4 border-b">${threshold}</td>
                        <td class="py-3 px-4 border-b">
                            <button class="edit-btn text-blue-500 hover:text-blue-700 mr-3" data-name="${product.name}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-700" data-id="${product.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // 添加编辑和删除事件监听
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.handleEditProduct(btn.dataset.name));
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.handleDeleteProduct(btn.dataset.id));
                });
            },
            
            // 渲染交易记录
            renderTransactions() {
                const tableBody = document.getElementById('transactionTableBody');
                const filter = document.getElementById('transactionFilter').value;
                
                // 过滤交易记录
                let filteredTransactions = this.transactions;
                if (filter === 'in') {
                    filteredTransactions = this.transactions.filter(t => t.type === 'in');
                } else if (filter === 'out') {
                    filteredTransactions = this.transactions.filter(t => t.type === 'out');
                }
                
                tableBody.innerHTML = '';
                
                if (filteredTransactions.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" class="py-4 px-4 text-center text-gray-500">暂无交易记录</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                filteredTransactions.forEach(transaction => {
                    const date = new Date(transaction.timestamp);
                    const formattedDate = date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const typeClass = transaction.type === 'in' ? 'text-green-600' : 'text-red-600';
                    const typeIcon = transaction.type === 'in' ? 'fa-arrow-down' : 'fa-arrow-up';
                    const typeText = transaction.type === 'in' ? '入库' : '出库';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-3 px-4 border-b">${formattedDate}</td>
                        <td class="py-3 px-4 border-b">${transaction.productName}</td>
                        <td class="py-3 px-4 border-b">
                            <span class="${typeClass}"><i class="fas ${typeIcon} mr-1"></i>${typeText}</span>
                        </td>
                        <td class="py-3 px-4 border-b">${transaction.quantity}</td>
                        <td class="py-3 px-4 border-b">${transaction.operator}</td>
                    `;
                    tableBody.appendChild(row);
                });
            },
            
            // 初始化图表
            initChart() {
                const ctx = document.getElementById('reportChart').getContext('2d');
                
                // 准备图表数据
                const inData = [];
                const outData = [];
                const labels = [];
                
                // 获取最近7天的日期标签
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }));
                }
                
                // 初始化数据数组
                for (let i = 0; i < 7; i++) {
                    inData.push(0);
                    outData.push(0);
                }
                
                // 填充交易数据
                this.transactions.forEach(transaction => {
                    const date = new Date(transaction.timestamp);
                    const today = new Date();
                    const diffTime = Math.abs(today - date);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 7) {
                        const index = 6 - diffDays; // 最近的一天在最右侧
                        if (transaction.type === 'in') {
                            inData[index] += transaction.quantity;
                        } else {
                            outData[index] += transaction.quantity;
                        }
                    }
                });
                
                // 创建图表
                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '入库数量',
                                data: inData,
                                backgroundColor: 'rgba(72, 187, 120, 0.6)',
                                borderColor: 'rgba(72, 187, 120, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '出库数量',
                                data: outData,
                                backgroundColor: 'rgba(237, 100, 166, 0.6)',
                                borderColor: 'rgba(237, 100, 166, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            },
            
            // 处理产品编辑
            handleEditProduct(productName) {
                const product = this.products.find(p => p.name === productName);
                if (!product) return;
                
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productionDate').value = product.productionDate || '';
                document.getElementById('shelfLife').value = product.shelfLife || '';
                
                // 自动填充告警阈值
                document.getElementById('productSelect').value = product.name;
                document.getElementById('customWarningThreshold').value = this.getProductThreshold(product.name);
            },
            
            // 处理产品删除
            handleDeleteProduct(productId) {
                if (confirm('确定要删除这个产品吗？此操作不可恢复。')) {
                    this.products = this.products.filter(p => p.id !== productId);
                    this.saveProducts();
                }
            }
        };

        // 页面加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
            
            // 登录按钮事件
            document.getElementById('loginBtn').addEventListener('click', () => {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                // 简单登录验证 (实际应用中应该有更安全的验证)
                if (username && password) {
                    AppState.currentUser = username;
                    StorageService.saveData(StorageService.KEYS.USER, username);
                    
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                } else {
                    alert('请输入用户名和密码');
                }
            });
            
            // 退出按钮事件
            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('确定要退出登录吗？')) {
                    StorageService.saveData(StorageService.KEYS.USER, null);
                    AppState.currentUser = null;
                    
                    document.getElementById('loginModal').classList.remove('hidden');
                    document.getElementById('mainContent').classList.add('hidden');
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                }
            });
            
            // 设置按钮事件
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsPanel').classList.toggle('active');
            });
            
            // 入库按钮事件
            document.getElementById('inBtn').addEventListener('click', () => {
                const productName = document.getElementById('productName').value.trim();
                const quantity = parseInt(document.getElementById('productQuantity').value) || 0;
                
                if (!productName) {
                    alert('请输入产品名称');
                    return;
                }
                
                if (quantity <= 0) {
                    alert('请输入有效的入库数量');
                    return;
                }
                
                AppState.updateProductStock(productName, quantity, true);
                AppState.addTransaction(productName, quantity, 'in');
                
                // 清空输入
                document.getElementById('productQuantity').value = '';
            });
            
            // 出库按钮事件
            document.getElementById('outBtn').addEventListener('click', () => {
                const productName = document.getElementById('productName').value.trim();
                const quantity = parseInt(document.getElementById('productQuantity').value) || 0;
                
                if (!productName) {
                    alert('请输入产品名称');
                    return;
                }
                
                if (quantity <= 0) {
                    alert('请输入有效的出库数量');
                    return;
                }
                
                const product = AppState.products.find(p => p.name === productName);
                if (!product || product.stock < quantity) {
                    alert('库存不足，无法出库');
                    return;
                }
                
                AppState.updateProductStock(productName, quantity, false);
                AppState.addTransaction(productName, quantity, 'out');
                
                // 清空输入
                document.getElementById('productQuantity').value = '';
            });
            
            // 保存系统设置按钮事件
            document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                const threshold = document.getElementById('defaultWarningThreshold').value;
                AppState.setDefaultThreshold(threshold);
                alert('默认告警阈值已保存');
            });
            
            // 保存产品告警阈值按钮事件
            document.getElementById('saveProductThresholdBtn').addEventListener('click', () => {
                const productName = document.getElementById('productSelect').value;
                const threshold = document.getElementById('customWarningThreshold').value;
                
                if (!productName) {
                    alert('请选择产品');
                    return;
                }
                
                if (!threshold || threshold < 0) {
                    alert('请输入有效的告警阈值');
                    return;
                }
                
                AppState.setProductThreshold(productName, threshold);
                alert('产品告警阈值已保存');
            });
            
            // 生成报表按钮事件
            document.getElementById('generateReportBtn').addEventListener('click', () => {
                // 这里可以添加生成报表的逻辑
                alert('报表已生成');
            });
            
            // 搜索框事件
            document.getElementById('searchInput').addEventListener('input', () => {
                AppState.currentPage = 1; // 重置到第一页
                AppState.renderInventory();
            });
            
            // 交易记录过滤事件
            document.getElementById('transactionFilter').addEventListener('change', () => {
                AppState.renderTransactions();
            });
            
            // 清空交易记录按钮事件
            document.getElementById('clearTransactionsBtn').addEventListener('click', () => {
                if (confirm('确定要清空所有交易记录吗？此操作不可恢复。')) {
                    AppState.transactions = [];
                    AppState.saveTransactions();
                }
            });
            
            // 分页按钮事件
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (AppState.currentPage > 1) {
                    AppState.currentPage--;
                    AppState.renderInventory();
                }
            });
            
            document.getElementById('nextPageBtn').addEventListener('click', () => {
                const searchInput = document.getElementById('searchInput').value.toLowerCase();
                let filteredProducts = AppState.products;
                
                if (searchInput) {
                    filteredProducts = AppState.products.filter(product => 
                        product.name.toLowerCase().includes(searchInput)
                    );
                }
                
                const maxPage = Math.ceil(filteredProducts.length / AppState.itemsPerPage);
                if (AppState.currentPage < maxPage) {
                    AppState.currentPage++;
                    AppState.renderInventory();
                }
            });
            
            // 产品选择变化事件
            document.getElementById('productSelect').addEventListener('change', (e) => {
                const productName = e.target.value;
                if (productName) {
                    const threshold = AppState.getProductThreshold(productName);
                    document.getElementById('customWarningThreshold').value = threshold;
                }
            });
        });
    </script>
</body>
</html>
